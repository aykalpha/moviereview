# 1. 事前準備
以下をインストール済みにしてください（既存の「Reactハンズオン」環境と同等）。
* Docker Desktop for Windows
  - 「Settings」で「Use the WSL 2 based engine」にチェックをしていること。
* Ubuntu
* WSL2
* VS Code
  - 拡張機能「Docker」「WSL」が入っていること
* Git
* DBeaver

# 2. Dockerとは？
* アプリ実行に必要な環境を「**コンテナ**」という単位でまとめて配布/再現できる仕組みです。
* 環境の設定を **Dockerfile** に記述することで、誰でも同じ環境を構築可能になります。
* 今回は **バックエンド(Laravel)**、**フロント(React)**、**データベース(PostgreSQL)** を**別々のコンテナ**として動かします。

# 3. プロジェクト構成
任意のUbuntu の作業ディレクトリ内に、以下のディレクトリ構成を作成します。  
（例： 「\\wsl.localhost\\Ubuntu-20.04\\home\\ユーザー名」配下 など）
```
moviereview/
├─ compose.yaml            # Dockerの設定ファイル
├─ Dockerfile              # 設定ファイル
├─ backend/                # Laravel プロジェクト（後で作成のため、現在は不要）
└─ frontend/               # React プロジェクト（後で作成のため、現在は不要）
```
> **補足**  
> 「バックエンドを Linux（Ubuntu）側」、「フロントを Windows 側」に分けて管理する方法もありますが、今回は両方ともLinux（Ubuntu）側で一括管理しています。

# 4. compose.yaml
以下の「compose.yaml`」を作成してください。
```
services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: moviereview-laravel
    ports:
      - "8000:8000"
    volumes:
      - ./laravel:/var/www/html
    command: sh -c "composer install && php artisan serve --host=0.0.0.0 --port=8000"
  node:
    image: node:24
    container_name: moviereview-react
    working_dir: /usr/src/app
    volumes:
      - ./react:/usr/src/app
    ports:
      - "3000:3000"
    command: sh -c "npm install && npm run start"
  db:
    image: postgres:15
    container_name: moviereview-postgres
    restart: always
    environment:
      POSTGRES_DB: moviereview
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
    ports:
      - "5432:5432"
```
## 解説
### Laravelコンテナ
| 項目                 | 内容                                                                                                                                       |
| ------------------ | ---------------------------------------------------------------------------------------------------------------------------------------- |
| **build**          | 「Dockerfile.laravel」を参照し、Laravel用のコンテナ作成します。                                                                              |
| **container_name** | コンテナ名を 「moviereview-laravel」とします。                                                                                                     |
| **ports**          | コンテナ内の8000番ポートを、Windows側の8000番ポートに公開します。 |
| **volumes**        | Windows側の「./laravel」を、コンテナ内の「/var/www/html」にマウント（共有）します。         |
| **command**        | 自動で「composer」で依存関係をインストールし、Laravelを起動するコマンドを記載しています。                                                      |

> **コンテナ名の重複注意**  
> 他プロジェクトで同名コンテナが存在するとエラーになります。  
> そのため、今回は一意になるよう「moviereview-laravel」という名前を使用しています。  

> **マウントとは？**  
> 「マウント」とは、「ホスト（Windows側）のディレクトリ」を、「コンテナ内の特定ディレクトリ」にリアルタイムで同期・共有する仕組みです。  
> これにより、ホスト上（Windows側）で編集したファイルを保存すると、即座にコンテナ内にも反映されます。


### Reactコンテナ
| 項目                 | 内容                                                                                                       |
| ------------------ | -------------------------------------------------------------------------------------------------------- |
| **image**          | 「node:24」のイメージを使用し、React用のコンテナ作成します。                                                                     |
| **container_name** | コンテナ名を「moviereview-react」とします。                                                                         |
| **working_dir**    | コンテナ内での作業ディレクトリを「/usr/src/app」に設定します。                                                                  |
| **volumes**        | Windows側の 「./react」を、コンテナ内の「/usr/src/app」にマウント（共有）します。 |
| **ports**          | コンテナ内の3000番ポートを、Windows側の3000番ポートに公開します。  |
| **command**        | 自動で依存パッケージをインストールし、Reactを起動するコマンドを記載しています。                              |
> **イメージとは？**  
> 「イメージ」とは、コンテナを作成するための設定が、既ににまとまったようなものです。
> たとえば、「node:24」は「Node.js のバージョン24がインストールされたイメージ」を意味します。
> イメージは「[Docker Hub](https://hub.docker.com/)」で検索できます。

### 「postgresコンテナ
| 項目                 | 内容                                                                                   |
| ------------------ | ------------------------------------------------------------------------------------ |
| **image**          | 「postgres:15」のイメージを使用し、postgres用のコンテナを作成します。                                      |
| **container_name** | コンテナ名を「moviereview-postgres」とします。                                                    |
| **restart**        | コンテナが停止した場合でも自動的に再起動するように設定しています。                                             |
| **environment**    | データベース名、ユーザー名、パスワードを指定します。 |
| **ports**          | コンテナ内の5432番ポートを、Windows側の5432番ポートに公開します。 |

# 5. Dockerfile
プロジェクト直下「Dockerfile」を作成してください。
```
FROM php:8.2-fpm

WORKDIR /var/www/html

# Composer をコピー
COPY --from=composer:latest /usr/bin/composer /usr/bin/composer

# 必要なパッケージをインストール
RUN apt-get update && apt-get install -y \
    build-essential \
    libpng-dev \
    libjpeg-dev \
    libfreetype6-dev \
    libpq-dev \
    libzip-dev \
    locales \
    zip \
    jpegoptim optipng pngquant gifsicle \
    vim \
    unzip \
    git \
    curl \
    && docker-php-ext-configure gd --with-freetype --with-jpeg \
    && docker-php-ext-configure zip \
    && docker-php-ext-install pdo pdo_pgsql pdo_mysql exif pcntl bcmath gd zip
```


# 6. Laravelプロジェクトの作成
1. Laravelプロジェクトを作成
以降のコマンドを、プロジェクト直下で実行してください。
```bash
docker-compose run --rm app composer create-project laravel/laravel .
```
2. 「.env」 を設定
「.env.example」より「.env」を作成してください。
データベース設定は、Dockerに記載した内容に合わせるようにしてください。
```env
DB_CONNECTION=pgsql
DB_HOST=db
DB_PORT=5432
DB_DATABASE=moviereview
DB_USERNAME=user
DB_PASSWORD=password
```
3. キー生成
```bash
docker exec -it moviereview-laravel php artisan key:generate
```


# 7. Reactプロジェクトの作成
1. Reactプロジェクトの作成
以降のコマンドを、プロジェクト直下で実行してください。
※「typescript」を使用するように指定しています。
```bash
docker-compose run --rm node npx create-react-app . --template typescript
```

# 8. コンテナのビルトと起動
以降のコマンドを、プロジェクト直下で実行してください。
```bash
docker compose up --build
```

# 9. DBeaverの接続設定
DBeaverで下記の接続先を設定してください。
※DBeaver内でPostgreSQLのドライバのインストール実行してください。
* **Server**: PostgreSQL
* **Host**: localhost
* **Port**: 5432
* **Database**: moviereview
* **Username**: user
* **Password**: password

# 10. 動作確認
* **Laravel**: [http://localhost:8000](http://localhost:8000)で初期ページが表示されること。
* **React**: [http://localhost:3000](http://localhost:3000)で初期ページが表示されること。
* **PostgreSQL**: DBeaver で上記設定の「テスト接続」が成功すること。